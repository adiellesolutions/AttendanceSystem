(() => {
    const API_BASE = "../../backend/api";
  
    const modal = document.getElementById("add-user-modal");
    const openBtn = document.getElementById("add-user-btn");
    const closeBtn = document.getElementById("close-modal-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const form = document.getElementById("add-user-form");
    const msg = document.getElementById("um_msg");
  
    const roleSel = document.getElementById("um_role");
    const roleSection = document.getElementById("role-specific-section");
    const studentSection = document.getElementById("student-section");
    const teacherSection = document.getElementById("teacher-section");
  
    function setMsg(text, isError = false) {
      if (!msg) return;
      msg.textContent = text || "";
      msg.className = "text-sm " + (isError ? "text-red-600" : "text-green-600");
    }
  
    function resetRoleSections() {
      roleSection?.classList.add("hidden");
      studentSection?.classList.add("hidden");
      teacherSection?.classList.add("hidden");
  
      // remove required flags first
      [
        "um_student_id", "um_student_fullname",
        "um_guardian_fullname", "um_guardian_email",
        "um_card_uid",
        "um_teacher_id", "um_teacher_fullname"
      ].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.required = false;
      });
    }
  
    function applyRoleUI(role) {
      resetRoleSections();
  
      if (role === "student") {
        roleSection?.classList.remove("hidden");
        studentSection?.classList.remove("hidden");
  
        document.getElementById("um_student_id").required = true;
        document.getElementById("um_student_fullname").required = true;
        document.getElementById("um_guardian_fullname").required = true;
        document.getElementById("um_guardian_email").required = true;
        document.getElementById("um_card_uid").required = true;
  
      } else if (role === "teacher") {
        roleSection?.classList.remove("hidden");
        teacherSection?.classList.remove("hidden");
  
        document.getElementById("um_teacher_id").required = true;
        document.getElementById("um_teacher_fullname").required = true;
      }
    }
  
    function openModal() {
      if (!modal) return;
      modal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      setMsg("");
    }
  
    function closeModal() {
      if (!modal) return;
      modal.classList.add("hidden");
      document.body.style.overflow = "auto";
      form?.reset();
      resetRoleSections();
      setMsg("");
    }
  
    // ✅ modal should NOT open automatically — only open on button click
    openBtn?.addEventListener("click", openModal);
  
    // ✅ close actions
    closeBtn?.addEventListener("click", closeModal);
    cancelBtn?.addEventListener("click", closeModal);
  
    // ✅ click outside closes
    modal?.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });
  
    // ✅ role change
    roleSel?.addEventListener("change", () => {
      applyRoleUI(roleSel.value);
    });
  
    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.message || "Request failed");
      return data;
    }
  
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMsg("");
  
      const username = document.getElementById("um_username")?.value.trim() || "";
      const password = document.getElementById("um_password")?.value || "";
      const role = document.getElementById("um_role")?.value || "";
      const status = document.getElementById("um_status")?.value || "active";
  
      if (!username || !password || !role || !status) {
        setMsg("Please complete Account section.", true);
        return;
      }
  
      const payload = { username, password, role, status };
  
      if (role === "student") {
        const student_id = document.getElementById("um_student_id")?.value.trim() || "";
        const full_name = document.getElementById("um_student_fullname")?.value.trim() || "";
        const email = document.getElementById("um_student_email")?.value.trim() || null;
  
        const g_full_name = document.getElementById("um_guardian_fullname")?.value.trim() || "";
        const g_email = document.getElementById("um_guardian_email")?.value.trim() || "";
        const g_contact = document.getElementById("um_guardian_contact")?.value.trim() || null;
  
        const card_uid = document.getElementById("um_card_uid")?.value.trim() || "";
        const card_status = document.getElementById("um_card_status")?.value || "active";
  
        if (!student_id || !full_name || !g_full_name || !g_email || !card_uid) {
          setMsg("Student role requires Student + Guardian + RFID fields.", true);
          return;
        }
  
        payload.student = { student_id, full_name, email };
        payload.guardian = { full_name: g_full_name, email: g_email, contact_no: g_contact };
        payload.card = { card_uid, status: card_status };
      }
  
      if (role === "teacher") {
        const teacher_id = document.getElementById("um_teacher_id")?.value.trim() || "";
        const full_name = document.getElementById("um_teacher_fullname")?.value.trim() || "";
        const email = document.getElementById("um_teacher_email")?.value.trim() || null;
  
        if (!teacher_id || !full_name) {
          setMsg("Teacher role requires Teacher ID + Full Name.", true);
          return;
        }
  
        payload.teacher = { teacher_id, full_name, email };
      }
  
      try {
        const res = await postJSON(`${API_BASE}/users_create.php`, payload);
        setMsg(res?.message || "Created successfully!");
        setTimeout(closeModal, 700);
      } catch (err) {
        setMsg(err.message, true);
      }
    });
  
    // Ensure modal is closed and role UI reset on load
    closeModal();
  })();
  